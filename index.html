<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Viewer</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0f172a; color:#e2e8f0; padding:20px; }
    #placeholder { padding:20px; border:1px dashed #334155; border-radius:8px; text-align:center; color:#94a3b8; }
    video { width:100%; max-height:400px; background:#111827; border:1px solid #334155; border-radius:8px; display:none; }
  </style>
</head>
<body>
  <h1>User Viewer</h1>
  <div id="placeholder">NO LIVE NOW</div>
  <video id="remoteVideo" autoplay playsinline controls></video>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-database-compat.js"></script>

  <script>
    // ðŸ”‘ Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBBZxCwywnv_ZVXYezOV8IKG6iKWK5sL10",
  authDomain: "studio-ywlo1.firebaseapp.com",
  projectId: "studio-ywlo1",
  storageBucket: "studio-ywlo1.firebasestorage.app",
  messagingSenderId: "791958850921",
  appId: "1:791958850921:web:149be668e7f132e59f41f8"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const roomRef = db.ref("/webrtc/globalRoom");

    const remoteVideo = document.getElementById("remoteVideo");
    const placeholder = document.getElementById("placeholder");

    let pc;

    function showLive(){
      placeholder.style.display = "none";
      remoteVideo.style.display = "block";
    }
    function showNoLive(){
      remoteVideo.style.display = "none";
      placeholder.style.display = "block";
      placeholder.textContent = "NO LIVE NOW";
    }

    // Listener wokhazikika pa roomRef
    roomRef.on("value", async snap=>{
      const room = snap.val();
      if(room && room.isLive && room.offer){
        // Admin ali live â†’ pangani peer connection
        pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});

        pc.ontrack = (event)=>{
          remoteVideo.srcObject = event.streams[0]; // âœ… video imayikidwa mkati mwa handler
          showLive();
        };

        pc.onicecandidate = e=>{
          if(e.candidate){ roomRef.child("answerCandidates").push(e.candidate.toJSON()); }
        };

        await pc.setRemoteDescription(new RTCSessionDescription(room.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await roomRef.child("answer").set(answer);

        roomRef.child("offerCandidates").on("child_added", snap=>{
          const cand = snap.val();
          if(cand){ pc.addIceCandidate(new RTCIceCandidate(cand)); }
        });
      } else {
        // Palibe live
        showNoLive();
        if(pc){ pc.close(); pc=null; }
      }
    });
  </script>
</body>
</html>